<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        *{
            margin: 0;
            padding: 0;
        }
        img{width: 100%;height: auto;}
    </style>
</head>
<body>
    <input type="file" name="" id="" onchange='selectFile(this)'  capture="camera" accept="image/*">
    <a><img src="" id="img" alt="" ></a>
    <script>
      function compressImage(file, config) {
    this.config = {
        unitsList: ['byte', 'kb', 'mb', 'gb'],
        units: 'byte',
        suffixList: ['image/png', 'image/webp','image/jpeg'],
        suffix: 'image/jpeg', 
        type: 1,
        isConvFile:true,
        ohterConfig: {
            width: '400',
            height: '400',
            zoomFactor: [0.4,0.4],
            compressratee:'',
            maxCompressratee:0.92,
            colorDepth:24,
            offset:[100,100],
            size:'400kb'
        },
        complete:function (data,blob) {

        }
    }
    for (let key in config) {
        if (key != 'ohterConfig') {
            this.config[key] = config[key]
        } else {
            for (let item in config['ohterConfig']) {
                this.config['ohterConfig'][item] = config['ohterConfig'][item]
            }
        }
    }
    this.blob ='',
    this.file = file;
    this.reader = new FileReader();
    this.img = new Image();
    this.canvas = document.createElement("canvas");
    this.context = this.canvas.getContext("2d");
    this.imageData = '';
    this.getImageInfo();
};
compressImage.prototype = {
    getImageInfo(){
        let self = this;
        if(!self.reader){
            alert("您的手机不支持FileReader")
            return
        }
        self.reader.addEventListener("load", () => {
            self.img.src = self.reader.result;
            self.imageData = self.reader.result;
            if (self.config.type == 1) {
                self.convSize();
            }
            self.img.addEventListener('load', () => {
                switch(self.config.type + ''){
                    case "1":
                        self.canvas.width = self.config.ohterConfig.width = self.img.naturalWidth;
                        self.canvas.height= self.config.ohterConfig.height = self.img.naturalHeight;
                        break;
                    case "2":
                        self.canvas.width = self.config.ohterConfig.width; 
                        self.canvas.height = self.config.ohterConfig.height;
                        break; 
                    case "3":
                        self.canvas.width = self.config.ohterConfig.width  = (self.img.naturalWidth - self.config.ohterConfig.offset[0] ) * self.config.ohterConfig.zoomFactor[0]; 
                        self.canvas.height = self.config.ohterConfig.height = (self.img.naturalHeight - self.config.ohterConfig.offset[1] ) * self.config.ohterConfig.zoomFactor[1];
                        break; 
                    case "4":
                        self.canvas.width = self.config.ohterConfig.width  = self.img.naturalWidth * self.config.ohterConfig.zoomFactor[0];
                        self.canvas.height = self.config.ohterConfig.height = self.img.naturalHeight * self.config.ohterConfig.zoomFactor[1];

                }
                self.drawImage();
            }, {
                once: true
            })
        },  {
            once: true
        });
        self.reader.readAsDataURL(self.file)
    },
    /**绘制图片*/
    drawImage() {  
        this.context.clearRect(0,0,this.canvas.width,this.canvas.height);
        switch (this.config.type + '') {
            case '1':
                this.context.drawImage(this.img, 0, 0, this.config.ohterConfig.width, this.config.ohterConfig.height);
                if(this.config.suffix == "image/png"){
                    console.warn("png格式的图片目前不支持清晰度压缩")
                }
                this.config.ohterConfig.compressratee = this.file.size > this.config.ohterConfig.size ? this.config.ohterConfig.size / this.file.size : 1;
                if(this.config.ohterConfig.compressratee < this.config.ohterConfig.maxCompressratee){
                    console.warn("压缩比例超过当前允许的最大压缩率对图片进行缩放")
                    let ratio = this.img.naturalWidth / this.img.naturalHeight 
                    
                    this.canvas.width = this.config.ohterConfig.width = Math.sqrt(this.config.ohterConfig.size / ratio);
                    this.canvas.height= this.config.ohterConfig.height = this.canvas.width / ratio;
                    this.context.drawImage(this.img,0,0, this.img.naturalWidth, this.img.naturalHeight,0,0,this.canvas.width,this.canvas.height);
                    this.imageData = this.canvas.toDataURL(this.config.suffix,this.config.ohterConfig.maxCompressratee * 1);     
                }else{
                    this.imageData = this.canvas.toDataURL(this.config.suffix,this.config.ohterConfig.compressratee * 1);      
                }       
                break;
            case "2":
                this.context.drawImage(this.img,this.config.ohterConfig.offset[0],this.config.ohterConfig.offset[1], this.config.ohterConfig.width, this.config.ohterConfig.height,0,0,this.canvas.width,this.canvas.height);
                this.imageData = this.canvas.toDataURL(this.config.suffix,1);
                break;
            case '3':
                this.context.drawImage(this.img, this.config.ohterConfig.offset[0],this.config.ohterConfig.offset[1], this.config.ohterConfig.width, this.config.ohterConfig.height,0,0,this.canvas.width,this.canvas.height);
                this.imageData = this.canvas.toDataURL(this.config.suffix,1);
                break;
            case "4":
                this.context.drawImage(this.img, 0,0, this.img.naturalWidth, this.img.naturalHeight,0,0,this.canvas.width,this.canvas.height);
                this.imageData = this.canvas.toDataURL(this.config.suffix,1);
                break;
        }
        if(this.config.isConvFile){
            this.dataURItoBlob(this.imageData,this.blob); 
        }
        this.config.complete(this.imageData,this.blob);         
    },

    /**
     * 进制转换将单位全部转化为字节
     */
    convSize() {
        if (/^\d+$/.test(this.config.size)) {
            this.config.size += this.config.units;
        }
        let size = this.config.ohterConfig.size.match(/\d*/)[0];
        let units = this.config.ohterConfig.size.match(/\D*$/)[0];
        if (this.config.unitsList.indexOf(units) > -1) {
            switch (units) {
                case 'byte':
                    this.config.ohterConfig.size = size;
                    break;
                case 'kb':
                    this.config.ohterConfig.size = size * 1024;
                    break;
                case 'mb':
                    this.config.ohterConfig.size = size * 1024 * 8;
                    break;
                case 'gb':
                    this.config.ohterConfig.size = size * 1024 * 1024 * 8;
                    break;
            }
        } else {
            throw new Error("转换单位不被允许")
        }
    },
    dataURItoBlob () {
        let arr = this.imageData.split(',')
        let mime = arr[0].match(/:(.*?);/)[1]
        if(!atob){
            alert("您的手机不支持文件格式转化")
            return
        }
        let bstr = atob(arr[1])
        let n = bstr.length
        let u8arr = new Uint8Array(n)
        while (n--) {
            u8arr[n] = bstr.charCodeAt(n)
        }
        this.blob = new File([u8arr], this.file.name, { type: mime });
    },
}
    </script>
    <script>
        function selectFile(self){
            var compres = new window.compressImage(self.files[0],{
                complete:function(data,blob){
                    console.log(blob)
                    document.getElementById("img").src = data
                }
            })
        }
    </script>
</body>
</html>
